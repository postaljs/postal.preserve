/**
 * postal.preserve - Add-on for postal.js that provides message durability features.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.1.0
 * Url: http://github.com/postaljs/postal.preserve
 * License(s): MIT
 */
(function(e,t){"object"==typeof module&&module.exports?module.exports=function(e){t(require("lodash"),require("conduit"),e,this)}:"function"==typeof define&&define.amd?define(["lodash","conduit","postal"],function(r,n,i){return t(r,n,i,e)}):e.postal=t(e._,e.Conduit,e.postal,e)})(this,function(e,t,r){function n(){var t=new Date,r=e.filter(i.expiring,function(e){return e.expires<t});for(console.log("Expired message count: "+r.length);r.length;)r.pop().purge()}{var i=r.preserve={store:{},expiring:[]},o=(r.channel(r.configuration.SYSTEM_CHANNEL),function(e,t){return t.expires-e.expires});r.addWireTap(function(t,r){function n(){i.store[s][c]=e.without(i.store[s][c],r),i.expiring=e.without(i.expiring,this)}var s=r.channel,c=r.topic;r.headers&&r.headers.preserve&&(i.store[s]=i.store[s]||{},i.store[s][c]=i.store[s][c]||[],i.store[s][c].push(r),r.purge=function(){n(),console.log("Message purged by subscriber")},r.headers.expires&&(i.expiring.push({expires:r.headers.expires,purge:n}),i.expiring.sort(o)))})}if(!r.subscribe.after){var s=r.subscribe;r.subscribe=new t.Sync({context:r,target:s})}return r.SubscriptionDefinition.prototype.enlistPreserved=function(){var t=this.channel,o=this.topic,s=this;return n(!0),i.store[t]&&e.each(i.store[t],function(t,n){r.configuration.resolver.compare(o,n)&&e.each(t,function(e){s.callback.call(s.context||s.callback.context&&s.callback.context()||this,e.data,e)})}),this},r});